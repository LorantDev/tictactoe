<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Super Tic Tac Toe</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=Syne+Mono&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #0e0e12;
  --surface: #16161d;
  --surface2: #1e1e28;
  --border: #2a2a38;
  --accent: #e8ff47;
  --accent2: #ff4f7b;
  --text: #f0f0f5;
  --muted: #6b6b80;
}

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Syne', sans-serif;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 1.5rem;
}

h1 {
  font-size: clamp(2rem, 7vw, 4rem);
  font-weight: 800;
  letter-spacing: -0.03em;
  line-height: 1;
  margin-bottom: 0.15em;
  background: linear-gradient(135deg, var(--accent) 0%, #fff 65%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  text-align: center;
}

.tagline {
  color: var(--muted);
  font-family: 'Syne Mono', monospace;
  font-size: 0.75rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  margin-bottom: 2.5rem;
  text-align: center;
}

.screen { display: none; flex-direction: column; align-items: center; gap: 1rem; animation: fadeIn 0.25s ease; }
.screen.active { display: flex; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

.btn {
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  font-size: 1rem;
  letter-spacing: 0.05em;
  padding: 0.85rem 2rem;
  border: 2px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.13s ease;
  width: 100%;
  max-width: 300px;
  text-align: center;
}
.btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-1px); }
.btn.primary { background: var(--accent); color: #0e0e12; border-color: var(--accent); }
.btn.primary:hover { background: #d4eb3a; border-color: #d4eb3a; color: #0e0e12; }
.btn.danger:hover { border-color: var(--accent2); color: var(--accent2); }

.input-group { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; max-width: 300px; }
input[type="text"] {
  font-family: 'Syne Mono', monospace;
  font-size: 1.4rem;
  letter-spacing: 0.3em;
  text-transform: uppercase;
  text-align: center;
  padding: 0.8rem 1rem;
  background: var(--surface);
  border: 2px solid var(--border);
  color: var(--text);
  border-radius: 4px;
  outline: none;
  width: 100%;
  transition: border-color 0.13s;
}
input[type="text"]:focus { border-color: var(--accent); }

.label {
  font-family: 'Syne Mono', monospace;
  font-size: 0.72rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  color: var(--muted);
  text-align: center;
}
.sep { width: 100%; max-width: 300px; height: 1px; background: var(--border); margin: 0.25rem 0; }
.error-msg { font-family: 'Syne Mono', monospace; font-size: 0.8rem; color: var(--accent2); text-align: center; min-height: 1.2em; }

.code-display {
  font-family: 'Syne Mono', monospace;
  font-size: 2.5rem;
  font-weight: 700;
  letter-spacing: 0.4em;
  color: var(--accent);
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: 6px;
  padding: 0.8rem 1.5rem;
  text-align: center;
}

.spinner {
  width: 26px; height: 26px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ Difficulty picker â”€â”€ */
.diff-buttons { display: flex; flex-direction: column; gap: 0.75rem; width: 100%; align-items: center; }
.diff-btn {
  font-family: 'Syne', sans-serif;
  font-weight: 700;
  font-size: 1rem;
  letter-spacing: 0.05em;
  padding: 0.85rem 2rem;
  border: 2px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.13s ease;
  width: 100%;
  max-width: 300px;
  text-align: center;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.diff-btn .diff-label { }
.diff-btn .diff-desc { font-size: 0.72rem; font-family: 'Syne Mono', monospace; color: var(--muted); letter-spacing: 0.05em; }
.diff-btn:hover { transform: translateY(-1px); }
.diff-btn.easy:hover  { border-color: #47ff8a; color: #47ff8a; }
.diff-btn.easy:hover .diff-desc { color: #47ff8a; opacity: 0.7; }
.diff-btn.medium:hover { border-color: var(--accent); color: var(--accent); }
.diff-btn.medium:hover .diff-desc { color: var(--accent); opacity: 0.7; }
.diff-btn.hard:hover  { border-color: var(--accent2); color: var(--accent2); }
.diff-btn.hard:hover .diff-desc { color: var(--accent2); opacity: 0.7; }

/* â”€â”€ Game UI â”€â”€ */
.game-wrap { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; width: 100%; }

.badges { display: flex; gap: 0.5rem; }
.player-badge {
  font-family: 'Syne Mono', monospace;
  font-size: 0.72rem;
  letter-spacing: 0.08em;
  padding: 0.3rem 0.9rem;
  border-radius: 20px;
  border: 1px solid var(--border);
  color: var(--muted);
  transition: all 0.2s;
}
.player-badge.active-x { border-color: var(--accent); color: var(--accent); box-shadow: 0 0 12px rgba(232,255,71,0.2); }
.player-badge.active-o { border-color: var(--accent2); color: var(--accent2); box-shadow: 0 0 12px rgba(255,79,123,0.2); }

.status {
  font-family: 'Syne Mono', monospace;
  font-size: 0.8rem;
  letter-spacing: 0.08em;
  color: var(--muted);
  text-align: center;
  min-height: 2.2em;
  display: flex;
  align-items: center;
  justify-content: center;
}
.status .hx { color: var(--accent); font-weight: 700; }
.status .ho { color: var(--accent2); font-weight: 700; }

.btn-row { display: flex; gap: 0.6rem; }
.btn-row .btn { max-width: 160px; font-size: 0.9rem; padding: 0.7rem 1rem; }

/* thinking dot animation */
.thinking::after {
  content: '';
  display: inline-block;
  animation: dots 1.2s steps(3, end) infinite;
}
@keyframes dots {
  0%   { content: ''; }
  33%  { content: '.'; }
  66%  { content: '..'; }
  100% { content: '...'; }
}

/* â”€â”€ Super Board â”€â”€ */
.super-board {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  gap: 6px;
  --sb-size: min(90vw, 520px);
  width: var(--sb-size);
  height: var(--sb-size);
}

.mini-board-wrap {
  position: relative;
  border: 2px solid var(--border);
  border-radius: 6px;
  background: var(--surface);
  overflow: hidden;
  transition: border-color 0.2s, background 0.2s;
}

.mini-board-wrap.target-x {
  border-color: rgba(232,255,71,0.55);
  background: rgba(232,255,71,0.04);
  box-shadow: 0 0 16px rgba(232,255,71,0.12);
}
.mini-board-wrap.target-o {
  border-color: rgba(255,79,123,0.55);
  background: rgba(255,79,123,0.04);
  box-shadow: 0 0 16px rgba(255,79,123,0.12);
}

.mini-board {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(3, 1fr);
  gap: 2px;
  width: 100%;
  height: 100%;
  padding: 4px;
}

.mini-cell {
  border-radius: 3px;
  background: var(--surface2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  cursor: pointer;
  transition: background 0.1s, color 0.1s;
  font-size: clamp(0.5rem, 2vw, 1.1rem);
  color: transparent;
  user-select: none;
}
.mini-cell.x { color: var(--accent); }
.mini-cell.o { color: var(--accent2); }
.mini-cell:hover:not(.taken):not(.locked) { background: #2a2a3a; }
.mini-cell.taken, .mini-cell.locked { cursor: default; }

.mini-won-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: clamp(1.5rem, 6vw, 3.5rem);
  pointer-events: none;
  border-radius: 4px;
  backdrop-filter: blur(1px);
}
.mini-won-overlay.x { background: rgba(232,255,71,0.12); color: var(--accent); text-shadow: 0 0 30px rgba(232,255,71,0.6); }
.mini-won-overlay.o { background: rgba(255,79,123,0.12); color: var(--accent2); text-shadow: 0 0 30px rgba(255,79,123,0.6); }
.mini-won-overlay.draw { background: rgba(107,107,128,0.15); color: var(--muted); font-size: clamp(1rem, 4vw, 2rem); letter-spacing: 0.1em; font-family: 'Syne Mono', monospace; }

.mini-board-wrap.big-win-x { border-color: var(--accent) !important; box-shadow: 0 0 20px rgba(232,255,71,0.25); }
.mini-board-wrap.big-win-o { border-color: var(--accent2) !important; box-shadow: 0 0 20px rgba(255,79,123,0.25); }

/* "You are" indicator for online game */
.you-are {
  font-family: 'Syne Mono', monospace;
  font-size: 0.72rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.35rem 1rem;
  border-radius: 20px;
  border: 1px solid var(--border);
  color: var(--muted);
}
.you-are .symbol { font-size: 1.1rem; font-weight: 800; line-height: 1; }
.you-are.is-x { border-color: rgba(232,255,71,0.4); color: var(--text); }
.you-are.is-x .symbol { color: var(--accent); }
.you-are.is-o { border-color: rgba(255,79,123,0.4); color: var(--text); }
.you-are.is-o .symbol { color: var(--accent2); }
</style>
</head>
<body>

<h1>SUPER<br>TIC TAC TOE</h1>
<p class="tagline">Nine boards. One champion.</p>

<!-- HOME -->
<div class="screen active" id="screen-home">
  <button class="btn primary" onclick="go('screen-local-game', startLocalGame)">Play Locally</button>
  <button class="btn" onclick="go('screen-online-menu')">Play Online</button>
  <button class="btn" onclick="go('screen-difficulty')">Training vs Computer</button>
</div>

<!-- DIFFICULTY PICKER -->
<div class="screen" id="screen-difficulty">
  <div class="label" style="margin-bottom:0.5rem">Choose difficulty</div>
  <div class="diff-buttons">
    <button class="diff-btn easy"   onclick="startCpuGame('easy')">
      <span class="diff-label">Easy</span>
      <span class="diff-desc">Random moves</span>
    </button>
    <button class="diff-btn medium" onclick="startCpuGame('medium')">
      <span class="diff-label">Medium</span>
      <span class="diff-desc">Thinks ahead</span>
    </button>
    <button class="diff-btn hard"   onclick="startCpuGame('hard')">
      <span class="diff-label">Hard</span>
      <span class="diff-desc">Plays to win</span>
    </button>
  </div>
  <button class="btn danger" onclick="go('screen-home')" style="margin-top:0.5rem">â† Back</button>
</div>

<!-- ONLINE MENU -->
<div class="screen" id="screen-online-menu">
  <button class="btn primary" onclick="createRoom()">Create Room</button>
  <div class="sep"></div>
  <div class="input-group">
    <div class="label">Join with code</div>
    <input type="text" id="join-code-input" maxlength="4" placeholder="0000" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,4)" inputmode="numeric" />
    <div class="error-msg" id="join-error"></div>
    <button class="btn" onclick="joinRoom()">Join Room</button>
  </div>
  <button class="btn danger" onclick="go('screen-home')">â† Back</button>
</div>

<!-- WAITING ROOM -->
<div class="screen" id="screen-waiting">
  <div class="label">Room Code</div>
  <div class="code-display" id="waiting-code">0000</div>
  <div class="label">Share this code with your opponent</div>
  <div class="spinner"></div>
  <div class="status">Waiting for opponent to joinâ€¦</div>
  <button class="btn danger" onclick="leaveOnline(); go('screen-home')">Cancel</button>
</div>

<!-- LOCAL GAME -->
<div class="screen" id="screen-local-game">
  <div class="game-wrap">
    <div class="badges">
      <span class="player-badge" id="local-badge-x">âœ• Player 1</span>
      <span class="player-badge" id="local-badge-o">â—‹ Player 2</span>
    </div>
    <div class="super-board" id="local-super-board"></div>
    <div class="status" id="local-status"></div>
    <div class="btn-row">
      <button class="btn" onclick="startLocalGame()">New Game</button>
      <button class="btn danger" onclick="go('screen-home')">â† Menu</button>
    </div>
  </div>
</div>

<!-- CPU GAME -->
<div class="screen" id="screen-cpu-game">
  <div class="game-wrap">
    <div class="badges">
      <span class="player-badge" id="cpu-badge-x">âœ• You</span>
      <span class="player-badge" id="cpu-badge-o">â—‹ Computer</span>
    </div>
    <div class="super-board" id="cpu-super-board"></div>
    <div class="status" id="cpu-status"></div>
    <div class="btn-row">
      <button class="btn" id="cpu-new-btn" onclick="restartCpuGame()">New Game</button>
      <button class="btn danger" onclick="go('screen-difficulty')">â† Difficulty</button>
    </div>
  </div>
</div>

<!-- ONLINE GAME -->
<div class="screen" id="screen-online-game">
  <div class="game-wrap">
    <div class="badges">
      <span class="player-badge" id="online-badge-x">âœ• You</span>
      <span class="player-badge" id="online-badge-o">â—‹ Opponent</span>
    </div>
    <div class="you-are" id="online-you-are">
      <span>You are</span>
      <span class="symbol" id="online-you-symbol">âœ•</span>
    </div>
    <div class="super-board" id="online-super-board"></div>
    <div class="status" id="online-status"></div>
    <div class="btn-row" id="online-btn-row" style="display:none">
      <button class="btn primary" onclick="requestRematch()">Play Again</button>
      <button class="btn danger" onclick="leaveOnline(); go('screen-home')">Leave</button>
    </div>
    <button class="btn danger" id="online-leave-btn" onclick="leaveOnline(); go('screen-home')">â† Leave Game</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREEN ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function go(id, cb) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (cb) cb();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SHARED GAME LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WINS = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

function checkMiniWinner(cells) {
  for (const [a,b,c] of WINS) {
    if (cells[a] !== null && cells[a] === cells[b] && cells[a] === cells[c]) return cells[a];
  }
  if (cells.every(c => c !== null)) return 'draw';
  return null;
}

function checkBigWinner(miniWinner) {
  for (const [a,b,c] of WINS) {
    if (miniWinner[a] !== null && miniWinner[a] !== 'draw' &&
        miniWinner[a] === miniWinner[b] && miniWinner[a] === miniWinner[c]) return miniWinner[a];
  }
  if (miniWinner.every(m => m !== null)) return 'draw';
  return null;
}

function freshGame() {
  return {
    cells: Array.from({ length: 9 }, () => Array(9).fill(null)),
    miniWinner: Array(9).fill(null),
    gameWinner: null,
    turn: 0,
    activeBoard: null
  };
}

function cloneGame(g) {
  return {
    cells: g.cells.map(b => b.slice()),
    miniWinner: g.miniWinner.slice(),
    gameWinner: g.gameWinner,
    turn: g.turn,
    activeBoard: g.activeBoard
  };
}

function applyMove(game, bi, ci) {
  if (game.gameWinner) return false;
  if (game.miniWinner[bi] !== null) return false;
  if (game.cells[bi][ci] !== null) return false;
  if (game.activeBoard !== null && game.activeBoard !== bi) return false;

  game.cells[bi][ci] = game.turn;

  const mw = checkMiniWinner(game.cells[bi]);
  if (mw !== null) game.miniWinner[bi] = mw;

  const gw = checkBigWinner(game.miniWinner);
  if (gw !== null) game.gameWinner = gw;

  if (!game.gameWinner) {
    game.activeBoard = (game.miniWinner[ci] !== null) ? null : ci;
    game.turn = 1 - game.turn;
  }
  return true;
}

function getLegalMoves(game) {
  if (game.gameWinner) return [];
  const moves = [];
  for (let bi = 0; bi < 9; bi++) {
    if (game.miniWinner[bi] !== null) continue;
    if (game.activeBoard !== null && game.activeBoard !== bi) continue;
    for (let ci = 0; ci < 9; ci++) {
      if (game.cells[bi][ci] === null) moves.push([bi, ci]);
    }
  }
  return moves;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOARD RENDERER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSuperBoard(boardEl, game, onCellClick, lockAll) {
  boardEl.innerHTML = '';
  for (let bi = 0; bi < 9; bi++) {
    const wrap = document.createElement('div');
    wrap.className = 'mini-board-wrap';

    const mw = game.miniWinner[bi];
    const isTarget = !lockAll && !game.gameWinner && mw === null &&
                     (game.activeBoard === null || game.activeBoard === bi);

    if (isTarget) wrap.classList.add(game.turn === 0 ? 'target-x' : 'target-o');

    if (mw !== null && mw !== 'draw') {
      const bigWin = checkBigWinner(game.miniWinner);
      if (bigWin !== null && bigWin !== 'draw') {
        for (const [a,b,c] of WINS) {
          if (game.miniWinner[a] === bigWin && game.miniWinner[b] === bigWin && game.miniWinner[c] === bigWin) {
            if (bi === a || bi === b || bi === c) {
              wrap.classList.add(bigWin === 0 ? 'big-win-x' : 'big-win-o');
            }
          }
        }
      }
    }

    const miniEl = document.createElement('div');
    miniEl.className = 'mini-board';

    for (let ci = 0; ci < 9; ci++) {
      const cell = document.createElement('div');
      const val = game.cells[bi][ci];
      cell.className = 'mini-cell';
      if (val === 0) { cell.classList.add('x', 'taken'); cell.textContent = 'âœ•'; }
      else if (val === 1) { cell.classList.add('o', 'taken'); cell.textContent = 'â—‹'; }
      else if (mw !== null) { cell.classList.add('locked'); }

      if (val === null && mw === null && !lockAll) {
        cell.onclick = () => onCellClick(bi, ci);
      }
      miniEl.appendChild(cell);
    }

    wrap.appendChild(miniEl);

    if (mw !== null) {
      const ov = document.createElement('div');
      ov.className = 'mini-won-overlay';
      if (mw === 0) { ov.classList.add('x'); ov.textContent = 'âœ•'; }
      else if (mw === 1) { ov.classList.add('o'); ov.textContent = 'â—‹'; }
      else { ov.classList.add('draw'); ov.textContent = 'DRAW'; }
      wrap.appendChild(ov);
    }

    boardEl.appendChild(wrap);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATUS HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gameStatusHTML(game, myIndex) {
  const isLocal = myIndex === undefined;
  if (game.gameWinner === 'draw') return "It's a draw!";
  if (game.gameWinner !== null) {
    const winner = game.gameWinner;
    if (isLocal) {
      const who = winner === 0 ? 'Player 1' : 'Player 2';
      return `<span class="${winner === 0 ? 'hx' : 'ho'}">${who} wins! ğŸ‰</span>`;
    } else {
      const iWon = winner === myIndex;
      return `<span class="${winner === 0 ? 'hx' : 'ho'}">${iWon ? 'You win! ğŸ‰' : 'Opponent wins.'}</span>`;
    }
  }
  const isFree = game.activeBoard === null;
  const turnLabel = game.turn === 0
    ? `<span class="hx">${isLocal ? 'Player 1' : (game.turn === myIndex ? 'You' : 'Opponent')}</span>`
    : `<span class="ho">${isLocal ? 'Player 2' : (game.turn === myIndex ? 'You' : 'Opponent')}</span>`;
  const suffix = isFree ? ' â€” pick any board' : '';
  return `${turnLabel}'s turn${suffix}`;
}

function updateBadges(xEl, oEl, game) {
  const over = game.gameWinner !== null;
  xEl.className = 'player-badge' + (!over && game.turn === 0 ? ' active-x' : '');
  oEl.className = 'player-badge' + (!over && game.turn === 1 ? ' active-o' : '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOCAL GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let localGame;

function startLocalGame() {
  localGame = freshGame();
  renderLocal();
}

function renderLocal() {
  const boardEl = document.getElementById('local-super-board');
  renderSuperBoard(boardEl, localGame, (bi, ci) => {
    if (localGame.gameWinner) return;
    applyMove(localGame, bi, ci);
    renderLocal();
  });
  document.getElementById('local-status').innerHTML = gameStatusHTML(localGame);
  updateBadges(document.getElementById('local-badge-x'), document.getElementById('local-badge-o'), localGame);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CPU_SIDE = 1; // computer always plays O
const HUMAN_SIDE = 0;

// â”€â”€ Heuristic evaluation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Score the position from CPU's perspective (positive = good for CPU)
function evaluate(game) {
  if (game.gameWinner === CPU_SIDE) return 100000;
  if (game.gameWinner === HUMAN_SIDE) return -100000;
  if (game.gameWinner === 'draw') return 0;

  let score = 0;

  // Score the macro board (mini-board winners)
  score += scoreLine(game.miniWinner, CPU_SIDE) * 100;
  score -= scoreLine(game.miniWinner, HUMAN_SIDE) * 100;

  // Score each individual mini-board's internal state
  for (let bi = 0; bi < 9; bi++) {
    if (game.miniWinner[bi] !== null) continue;
    const miniScore = scoreLine(game.cells[bi], CPU_SIDE) - scoreLine(game.cells[bi], HUMAN_SIDE);
    // Weight center and corner mini-boards slightly higher
    const posWeight = [1.2, 1.0, 1.2, 1.0, 1.5, 1.0, 1.2, 1.0, 1.2][bi];
    score += miniScore * posWeight;
  }

  // Small bonus for center cell of each mini-board
  for (let bi = 0; bi < 9; bi++) {
    if (game.miniWinner[bi] !== null) continue;
    if (game.cells[bi][4] === CPU_SIDE) score += 3;
    if (game.cells[bi][4] === HUMAN_SIDE) score -= 3;
  }

  return score;
}

// Count two-in-a-row threats for `side` in a 9-cell line (board or miniWinner array)
function scoreLine(line, side) {
  let score = 0;
  for (const [a,b,c] of WINS) {
    const vals = [line[a], line[b], line[c]];
    const mine = vals.filter(v => v === side).length;
    const empty = vals.filter(v => v === null).length;
    const opponent = vals.filter(v => v !== null && v !== side && v !== 'draw').length;
    if (opponent === 0) {
      if (mine === 3) score += 1000;
      else if (mine === 2 && empty === 1) score += 10;
      else if (mine === 1 && empty === 2) score += 1;
    }
  }
  return score;
}

// â”€â”€ Minimax with alpha-beta pruning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function minimax(game, depth, alpha, beta, maximizing) {
  if (game.gameWinner !== null || depth === 0) return evaluate(game);

  const moves = getLegalMoves(game);
  if (moves.length === 0) return evaluate(game);

  if (maximizing) {
    let best = -Infinity;
    for (const [bi, ci] of moves) {
      const g2 = cloneGame(game);
      applyMove(g2, bi, ci);
      best = Math.max(best, minimax(g2, depth - 1, alpha, beta, false));
      alpha = Math.max(alpha, best);
      if (beta <= alpha) break;
    }
    return best;
  } else {
    let best = Infinity;
    for (const [bi, ci] of moves) {
      const g2 = cloneGame(game);
      applyMove(g2, bi, ci);
      best = Math.min(best, minimax(g2, depth - 1, alpha, beta, true));
      beta = Math.min(beta, best);
      if (beta <= alpha) break;
    }
    return best;
  }
}

// â”€â”€ Move selectors per difficulty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cpuMoveEasy(game) {
  const moves = getLegalMoves(game);
  return moves[Math.floor(Math.random() * moves.length)];
}

function cpuMoveMedium(game) {
  const moves = getLegalMoves(game);
  if (moves.length === 0) return null;

  // Shuffle for variety
  for (let i = moves.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [moves[i], moves[j]] = [moves[j], moves[i]];
  }

  let bestScore = -Infinity;
  let bestMove = moves[0];
  // Depth 3 â€” fast, plays sensibly
  for (const [bi, ci] of moves) {
    const g2 = cloneGame(game);
    applyMove(g2, bi, ci);
    const score = minimax(g2, 3, -Infinity, Infinity, false);
    if (score > bestScore) { bestScore = score; bestMove = [bi, ci]; }
  }
  return bestMove;
}

function cpuMoveHard(game) {
  const moves = getLegalMoves(game);
  if (moves.length === 0) return null;

  // Shuffle for variety on equal-score moves
  for (let i = moves.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [moves[i], moves[j]] = [moves[j], moves[i]];
  }

  // Reduce depth when branching factor is very high (free choice = up to 81 moves)
  const depth = game.activeBoard === null ? 4 : 5;

  let bestScore = -Infinity;
  let bestMove = moves[0];
  let alpha = -Infinity;
  for (const [bi, ci] of moves) {
    const g2 = cloneGame(game);
    applyMove(g2, bi, ci);
    const score = minimax(g2, depth - 1, alpha, Infinity, false);
    if (score > bestScore) { bestScore = score; bestMove = [bi, ci]; alpha = score; }
  }
  return bestMove;
}

// â”€â”€ Dispatch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function cpuPickMove(game, difficulty) {
  if (difficulty === 'easy')   return cpuMoveEasy(game);
  if (difficulty === 'medium') return cpuMoveMedium(game);
  return cpuMoveHard(game);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CPU GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cpuGame, cpuDifficulty, cpuThinking, cpuGeneration = 0;

function startCpuGame(difficulty) {
  cpuDifficulty = difficulty;
  cpuGame = freshGame();
  cpuThinking = false;
  cpuGeneration++;
  go('screen-cpu-game');
  renderCpu();
}

function restartCpuGame() {
  startCpuGame(cpuDifficulty);
}

function renderCpu() {
  const boardEl = document.getElementById('cpu-super-board');
  const isHumanTurn = cpuGame.turn === HUMAN_SIDE && !cpuGame.gameWinner && !cpuThinking;

  renderSuperBoard(boardEl, cpuGame, (bi, ci) => {
    if (cpuThinking || cpuGame.turn !== HUMAN_SIDE || cpuGame.gameWinner) return;
    applyMove(cpuGame, bi, ci);
    renderCpu();
    if (!cpuGame.gameWinner) scheduleCpuMove();
  }, !isHumanTurn /* lockAll when it's not human's turn */);

  const statusEl = document.getElementById('cpu-status');

  if (cpuGame.gameWinner !== null) {
    if (cpuGame.gameWinner === 'draw') {
      statusEl.innerHTML = "It's a draw!";
    } else if (cpuGame.gameWinner === HUMAN_SIDE) {
      statusEl.innerHTML = '<span class="hx">You win! ğŸ‰</span>';
    } else {
      statusEl.innerHTML = '<span class="ho">Computer wins.</span>';
    }
  } else if (cpuThinking) {
    statusEl.innerHTML = '<span class="ho thinking">Computer is thinking</span>';
  } else {
    const isFree = cpuGame.activeBoard === null;
    statusEl.innerHTML = '<span class="hx">Your turn' + (isFree ? ' â€” pick any board' : '') + '</span>';
  }

  updateBadges(document.getElementById('cpu-badge-x'), document.getElementById('cpu-badge-o'), cpuGame);
}

function scheduleCpuMove() {
  cpuThinking = true;
  renderCpu(); // show "thinking" immediately

  const gen = cpuGeneration;
  // Small delay so the UI updates and thinking animation shows
  setTimeout(() => {
    if (gen !== cpuGeneration) return; // new game started, discard
    const move = cpuPickMove(cpuGame, cpuDifficulty);
    if (gen !== cpuGeneration) return; // check again after computation
    if (move) {
      applyMove(cpuGame, move[0], move[1]);
    }
    cpuThinking = false;
    renderCpu();
  }, cpuDifficulty === 'easy' ? 300 : cpuDifficulty === 'medium' ? 500 : 600);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ONLINE GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ws, myIndex, onlineGame, onlineOver, currentRoomCode;
const WS_URL = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`;

function connectWS() {
  return new Promise((resolve, reject) => {
    ws = new WebSocket(WS_URL);
    ws.onopen = resolve;
    ws.onerror = reject;
    ws.onmessage = (e) => handleMsg(JSON.parse(e.data));
    ws.onclose = () => {
      if (!onlineOver) setOnlineStatus('Connection lost. <span class="ho">Opponent disconnected.</span>');
      onlineOver = true;
      document.getElementById('online-btn-row').style.display = 'flex';
      document.getElementById('online-leave-btn').style.display = 'none';
    };
  });
}

async function createRoom() {
  try {
    await connectWS();
    ws.send(JSON.stringify({ type: 'create' }));
  } catch { document.getElementById('join-error').textContent = 'Cannot connect to server.'; }
}

async function joinRoom() {
  const code = document.getElementById('join-code-input').value.trim();
  document.getElementById('join-error').textContent = '';
  if (!/^[0-9]{4}$/.test(code)) { document.getElementById('join-error').textContent = 'Enter a 4-digit code.'; return; }
  try {
    await connectWS();
    ws.send(JSON.stringify({ type: 'join', code }));
  } catch { document.getElementById('join-error').textContent = 'Cannot connect to server.'; }
}

function leaveOnline() {
  if (ws) { ws.onclose = null; ws.close(); ws = null; }
  onlineOver = true;
}

function handleMsg(msg) {
  if (msg.type === 'created') {
    myIndex = 0;
    currentRoomCode = msg.code;
    document.getElementById('waiting-code').textContent = msg.code;
    go('screen-waiting');
  }
  else if (msg.type === 'joined') {
    myIndex = msg.playerIndex;
    currentRoomCode = msg.code;
    go('screen-online-game');
    setOnlineStatus('Waiting for game to startâ€¦');
  }
  else if (msg.type === 'error') {
    document.getElementById('join-error').textContent = msg.msg;
    if (ws) { ws.onclose = null; ws.close(); ws = null; }
  }
  else if (msg.type === 'start') {
    onlineGame = msg.game;
    onlineOver = false;
    go('screen-online-game');
    initOnlineUI();
    renderOnline();
  }
  else if (msg.type === 'update') {
    onlineGame = msg.game;
    renderOnline();
    if (onlineGame.gameWinner !== null) {
      onlineOver = true;
      document.getElementById('online-btn-row').style.display = 'flex';
      document.getElementById('online-leave-btn').style.display = 'none';
    }
  }
  else if (msg.type === 'rematch_waiting') {
    setOnlineStatus('Waiting for opponentâ€¦');
  }
  else if (msg.type === 'opponent_left') {
    setOnlineStatus('Opponent disconnected. Room held for 5 min â€” share code <span class="hx">' + currentRoomCode + '</span> to let them rejoin.');
    document.getElementById('online-btn-row').style.display = 'none';
    document.getElementById('online-leave-btn').style.display = 'block';
  }
}

function initOnlineUI() {
  document.getElementById('online-btn-row').style.display = 'none';
  document.getElementById('online-leave-btn').style.display = 'block';
  const bx = document.getElementById('online-badge-x');
  const bo = document.getElementById('online-badge-o');
  if (myIndex === 0) { bx.textContent = 'âœ• You'; bo.textContent = 'â—‹ Opponent'; }
  else { bx.textContent = 'âœ• Opponent'; bo.textContent = 'â—‹ You'; }
  const youAre = document.getElementById('online-you-are');
  const youSym = document.getElementById('online-you-symbol');
  if (myIndex === 0) { youAre.className = 'you-are is-x'; youSym.textContent = 'âœ•'; }
  else { youAre.className = 'you-are is-o'; youSym.textContent = 'â—‹'; }
}

function renderOnline() {
  const boardEl = document.getElementById('online-super-board');
  renderSuperBoard(boardEl, onlineGame, (bi, ci) => {
    if (onlineOver || onlineGame.gameWinner !== null) return;
    if (onlineGame.turn !== myIndex) return;
    ws.send(JSON.stringify({ type: 'move', bi, ci }));
  });
  setOnlineStatus(gameStatusHTML(onlineGame, myIndex));
  updateBadges(document.getElementById('online-badge-x'), document.getElementById('online-badge-o'), onlineGame);
}

function setOnlineStatus(html) {
  document.getElementById('online-status').innerHTML = html;
}

function requestRematch() {
  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify({ type: 'rematch' }));
    setOnlineStatus('Waiting for opponent to agreeâ€¦');
    document.getElementById('online-btn-row').style.display = 'none';
  }
}

// Init
startLocalGame();
</script>
</body>
</html>
