<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tic Tac Toe</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=Syne+Mono&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0e0e12;
    --surface: #16161d;
    --border: #2a2a38;
    --accent: #e8ff47;
    --accent2: #ff4f7b;
    --text: #f0f0f5;
    --muted: #6b6b80;
    --cell-size: 110px;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem;
  }

  h1 {
    font-size: clamp(2.5rem, 8vw, 5rem);
    font-weight: 800;
    letter-spacing: -0.03em;
    line-height: 1;
    margin-bottom: 0.2em;
    background: linear-gradient(135deg, var(--accent) 0%, #fff 60%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .tagline {
    color: var(--muted);
    font-family: 'Syne Mono', monospace;
    font-size: 0.8rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 3rem;
  }

  .screen { display: none; flex-direction: column; align-items: center; gap: 1rem; animation: fadeIn 0.3s ease; }
  .screen.active { display: flex; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  .btn {
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 1rem;
    letter-spacing: 0.05em;
    padding: 0.9rem 2.5rem;
    border: 2px solid var(--border);
    background: var(--surface);
    color: var(--text);
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.15s ease;
    width: 100%;
    max-width: 300px;
    text-align: center;
  }
  .btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-1px); }
  .btn.primary { background: var(--accent); color: #0e0e12; border-color: var(--accent); }
  .btn.primary:hover { background: #d4eb3a; border-color: #d4eb3a; color: #0e0e12; transform: translateY(-1px); }
  .btn.danger:hover { border-color: var(--accent2); color: var(--accent2); }

  .input-group { display: flex; flex-direction: column; gap: 0.5rem; width: 100%; max-width: 300px; }
  input[type="text"] {
    font-family: 'Syne Mono', monospace;
    font-size: 1.4rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    text-align: center;
    padding: 0.8rem 1rem;
    background: var(--surface);
    border: 2px solid var(--border);
    color: var(--text);
    border-radius: 4px;
    outline: none;
    width: 100%;
    transition: border-color 0.15s;
  }
  input[type="text"]:focus { border-color: var(--accent); }

  .board {
    display: grid;
    grid-template-columns: repeat(3, var(--cell-size));
    grid-template-rows: repeat(3, var(--cell-size));
    gap: 8px;
    margin: 1.5rem 0;
  }

  .cell {
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.12s ease;
    user-select: none;
    position: relative;
    overflow: hidden;
  }
  .cell:hover:not(.taken) { border-color: var(--accent); background: #1e1e28; }
  .cell.taken { cursor: default; }
  .cell.x { color: var(--accent); }
  .cell.o { color: var(--accent2); }
  .cell.win { border-color: var(--accent); background: rgba(232,255,71,0.08); }
  .cell.win.o { border-color: var(--accent2); background: rgba(255,79,123,0.08); }

  .status {
    font-family: 'Syne Mono', monospace;
    font-size: 0.85rem;
    letter-spacing: 0.1em;
    color: var(--muted);
    text-align: center;
    min-height: 2.5em;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .status .highlight { color: var(--accent); font-weight: 700; }
  .status .highlight.o { color: var(--accent2); }

  .code-display {
    font-family: 'Syne Mono', monospace;
    font-size: 2.5rem;
    font-weight: 700;
    letter-spacing: 0.4em;
    color: var(--accent);
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 6px;
    padding: 1rem 2rem;
    text-align: center;
  }

  .label {
    font-family: 'Syne Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    text-align: center;
  }

  .sep { width: 100%; max-width: 300px; height: 1px; background: var(--border); margin: 0.5rem 0; }

  .error-msg {
    font-family: 'Syne Mono', monospace;
    font-size: 0.8rem;
    color: var(--accent2);
    text-align: center;
    min-height: 1.2em;
  }

  .player-badge {
    font-family: 'Syne Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    border: 1px solid var(--border);
    color: var(--muted);
  }
  .player-badge.active-x { border-color: var(--accent); color: var(--accent); }
  .player-badge.active-o { border-color: var(--accent2); color: var(--accent2); }

  .btn-row { display: flex; gap: 0.75rem; width: 100%; max-width: 300px; }
  .btn-row .btn { max-width: none; }

  .spinner {
    width: 28px; height: 28px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<h1>TIC TAC TOE</h1>
<p class="tagline">Two players. One winner.</p>

<!-- HOME -->
<div class="screen active" id="screen-home">
  <button class="btn primary" onclick="go('screen-local-game', startLocalGame)">Play Locally</button>
  <button class="btn" onclick="go('screen-online-menu')">Play on the Internet</button>
</div>

<!-- ONLINE MENU -->
<div class="screen" id="screen-online-menu">
  <button class="btn primary" onclick="createRoom()">Create Room</button>
  <div class="sep"></div>
  <div class="input-group">
    <div class="label">Join with code</div>
    <input type="text" id="join-code-input" maxlength="5" placeholder="XXXXX" oninput="this.value=this.value.toUpperCase()" />
    <div class="error-msg" id="join-error"></div>
    <button class="btn" onclick="joinRoom()">Join Room</button>
  </div>
  <button class="btn danger" onclick="go('screen-home')">‚Üê Back</button>
</div>

<!-- WAITING ROOM -->
<div class="screen" id="screen-waiting">
  <div class="label">Room Code</div>
  <div class="code-display" id="waiting-code">XXXXX</div>
  <div class="label">Share this code with your opponent</div>
  <div class="spinner"></div>
  <div class="status">Waiting for opponent to join‚Ä¶</div>
  <button class="btn danger" onclick="leaveOnline(); go('screen-home')">Cancel</button>
</div>

<!-- LOCAL GAME -->
<div class="screen" id="screen-local-game">
  <div style="display:flex;gap:0.5rem">
    <span class="player-badge" id="local-badge-x">‚úï Player 1</span>
    <span class="player-badge" id="local-badge-o">‚óã Player 2</span>
  </div>
  <div class="board" id="local-board"></div>
  <div class="status" id="local-status"></div>
  <div class="btn-row">
    <button class="btn" onclick="startLocalGame()">New Game</button>
    <button class="btn danger" onclick="go('screen-home')">‚Üê Menu</button>
  </div>
</div>

<!-- ONLINE GAME -->
<div class="screen" id="screen-online-game">
  <div style="display:flex;gap:0.5rem">
    <span class="player-badge" id="online-badge-x">‚úï You</span>
    <span class="player-badge" id="online-badge-o">‚óã Opponent</span>
  </div>
  <div class="board" id="online-board"></div>
  <div class="status" id="online-status"></div>
  <div class="btn-row" id="online-btn-row" style="display:none">
    <button class="btn" onclick="requestRematch()">Play Again</button>
    <button class="btn danger" onclick="leaveOnline(); go('screen-home')">Leave</button>
  </div>
  <button class="btn danger" id="online-leave-btn" onclick="leaveOnline(); go('screen-home')">‚Üê Leave Game</button>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ Screen Router ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function go(id, cb) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if (cb) cb();
}

// ‚îÄ‚îÄ‚îÄ LOCAL GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let localBoard, localTurn, localOver;

function startLocalGame() {
  localBoard = Array(9).fill(null);
  localTurn = 0;
  localOver = false;
  renderLocalBoard();
  updateLocalStatus();
}

function renderLocalBoard() {
  const el = document.getElementById('local-board');
  el.innerHTML = '';
  localBoard.forEach((v, i) => {
    const cell = document.createElement('div');
    cell.className = 'cell' + (v !== null ? ' taken' : '') + (v === 0 ? ' x' : v === 1 ? ' o' : '');
    cell.textContent = v === 0 ? '‚úï' : v === 1 ? '‚óã' : '';
    cell.onclick = () => localMove(i);
    el.appendChild(cell);
  });
  // highlight wins
  const w = winCells(localBoard);
  if (w) w.forEach(i => el.children[i].classList.add('win'));
}

function localMove(i) {
  if (localOver || localBoard[i] !== null) return;
  localBoard[i] = localTurn;
  const w = winCells(localBoard);
  const draw = !w && localBoard.every(c => c !== null);
  if (w || draw) localOver = true;
  else localTurn = 1 - localTurn;
  renderLocalBoard();
  updateLocalStatus(w, draw);
}

function updateLocalStatus(w, draw) {
  const s = document.getElementById('local-status');
  const bx = document.getElementById('local-badge-x');
  const bo = document.getElementById('local-badge-o');
  bx.className = 'player-badge' + (localTurn === 0 && !localOver ? ' active-x' : '');
  bo.className = 'player-badge' + (localTurn === 1 && !localOver ? ' active-o' : '');
  if (w) {
    const who = localBoard[w[0]] === 0;
    s.innerHTML = `<span class="highlight${who ? '' : ' o'}">${who ? 'Player 1 wins!' : 'Player 2 wins!'}</span>`;
  } else if (draw) {
    s.innerHTML = `It's a draw!`;
  } else {
    s.innerHTML = `<span class="highlight${localTurn ? ' o' : ''}">${localTurn === 0 ? 'Player 1' : 'Player 2'}</span>'s turn`;
  }
}

// ‚îÄ‚îÄ‚îÄ ONLINE GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let ws, myIndex, onlineBoard, onlineTurn, onlineOver;

const WS_URL = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}`;

function connectWS() {
  return new Promise((resolve, reject) => {
    ws = new WebSocket(WS_URL);
    ws.onopen = resolve;
    ws.onerror = reject;
    ws.onmessage = (e) => handleMsg(JSON.parse(e.data));
    ws.onclose = () => {
      if (!onlineOver) setOnlineStatus('Connection lost. <span style="color:var(--accent2)">Opponent disconnected.</span>');
      document.getElementById('online-btn-row').style.display = 'flex';
      document.getElementById('online-leave-btn').style.display = 'none';
      onlineOver = true;
    };
  });
}

async function createRoom() {
  try {
    await connectWS();
    ws.send(JSON.stringify({ type: 'create' }));
  } catch { document.getElementById('join-error').textContent = 'Cannot connect to server.'; }
}

async function joinRoom() {
  const code = document.getElementById('join-code-input').value.trim().toUpperCase();
  document.getElementById('join-error').textContent = '';
  if (code.length !== 5) { document.getElementById('join-error').textContent = 'Enter a 5-character code.'; return; }
  try {
    await connectWS();
    ws.send(JSON.stringify({ type: 'join', code }));
  } catch { document.getElementById('join-error').textContent = 'Cannot connect to server.'; }
}

function leaveOnline() {
  if (ws) { ws.onclose = null; ws.close(); ws = null; }
  onlineOver = true;
}

function handleMsg(msg) {
  if (msg.type === 'created') {
    myIndex = 0;
    document.getElementById('waiting-code').textContent = msg.code;
    go('screen-waiting');
  }
  else if (msg.type === 'joined') {
    myIndex = 1;
    go('screen-online-game');
    initOnlineGame();
    setOnlineStatus('Waiting for game to start‚Ä¶');
  }
  else if (msg.type === 'error') {
    document.getElementById('join-error').textContent = msg.msg;
    if (ws) { ws.onclose = null; ws.close(); ws = null; }
  }
  else if (msg.type === 'start') {
    go('screen-online-game');
    onlineBoard = msg.board;
    onlineTurn = msg.turn;
    onlineOver = false;
    initOnlineGame();
    renderOnlineBoard();
    updateOnlineStatus();
  }
  else if (msg.type === 'update') {
    onlineBoard = msg.board;
    onlineTurn = msg.turn;
    const w = winCells(onlineBoard);
    const draw = msg.draw;
    if (msg.winner !== null && msg.winner !== undefined) onlineOver = true;
    if (draw) onlineOver = true;
    renderOnlineBoard();
    updateOnlineStatus(msg.winner !== null && msg.winner !== undefined ? winCells(onlineBoard) : null, draw, msg.winner);
    if (onlineOver) {
      document.getElementById('online-btn-row').style.display = 'flex';
      document.getElementById('online-leave-btn').style.display = 'none';
    }
  }
  else if (msg.type === 'rematch_waiting') {
    setOnlineStatus('Waiting for opponent to agree‚Ä¶');
  }
  else if (msg.type === 'opponent_left') {
    setOnlineStatus('<span style="color:var(--accent2)">Opponent left the game.</span>');
    onlineOver = true;
    document.getElementById('online-btn-row').style.display = 'none';
    document.getElementById('online-leave-btn').style.display = 'block';
  }
}

function initOnlineGame() {
  onlineOver = false;
  document.getElementById('online-btn-row').style.display = 'none';
  document.getElementById('online-leave-btn').style.display = 'block';
  const bx = document.getElementById('online-badge-x');
  const bo = document.getElementById('online-badge-o');
  if (myIndex === 0) { bx.textContent = '‚úï You'; bo.textContent = '‚óã Opponent'; }
  else { bx.textContent = '‚úï Opponent'; bo.textContent = '‚óã You'; }
}

function renderOnlineBoard() {
  const el = document.getElementById('online-board');
  el.innerHTML = '';
  onlineBoard.forEach((v, i) => {
    const cell = document.createElement('div');
    cell.className = 'cell' + (v !== null ? ' taken' : '') + (v === 0 ? ' x' : v === 1 ? ' o' : '');
    cell.textContent = v === 0 ? '‚úï' : v === 1 ? '‚óã' : '';
    cell.onclick = () => onlineMove(i);
    el.appendChild(cell);
  });
  const w = winCells(onlineBoard);
  if (w) {
    w.forEach(i => {
      el.children[i].classList.add('win');
      if (onlineBoard[i] === 1) el.children[i].classList.add('o');
    });
  }
}

function onlineMove(i) {
  if (onlineOver || onlineBoard[i] !== null || onlineTurn !== myIndex) return;
  ws.send(JSON.stringify({ type: 'move', index: i }));
}

function updateOnlineStatus(w, draw, winner) {
  const bx = document.getElementById('online-badge-x');
  const bo = document.getElementById('online-badge-o');
  bx.className = 'player-badge' + (onlineTurn === 0 && !onlineOver ? ' active-x' : '');
  bo.className = 'player-badge' + (onlineTurn === 1 && !onlineOver ? ' active-o' : '');

  if (w && winner !== undefined && winner !== null) {
    const iWon = winner === myIndex;
    setOnlineStatus(`<span class="highlight${winner === 1 ? ' o' : ''}">${iWon ? 'You win! üéâ' : 'Opponent wins.'}</span>`);
  } else if (draw) {
    setOnlineStatus("It's a draw!");
  } else {
    const myTurn = onlineTurn === myIndex;
    setOnlineStatus(`<span class="highlight${onlineTurn === 1 ? ' o' : ''}">${myTurn ? 'Your turn' : "Opponent's turn"}</span>`);
  }
}

function setOnlineStatus(html) {
  document.getElementById('online-status').innerHTML = html;
}

function requestRematch() {
  if (ws && ws.readyState === 1) {
    ws.send(JSON.stringify({ type: 'rematch' }));
    setOnlineStatus('Waiting for opponent to agree‚Ä¶');
    document.getElementById('online-btn-row').style.display = 'none';
  }
}

// ‚îÄ‚îÄ‚îÄ Win Logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const WINS = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
function winCells(board) {
  for (const [a,b,c] of WINS) {
    if (board[a] !== null && board[a] === board[b] && board[a] === board[c]) return [a,b,c];
  }
  return null;
}

// Init local board on page load
startLocalGame();
</script>
</body>
</html>
